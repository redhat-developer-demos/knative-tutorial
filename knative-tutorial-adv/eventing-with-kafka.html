<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Knative Tutorial :: Knative Tutorial</title>
    <link rel="canonical" href="https://redhat-developer-demos.github.io/knative-tutorial/knative-tutorial-adv/eventing-with-kafka.html">
    <meta name="generator" content="Antora 2.3.3">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-developer-demos.github.io/knative-tutorial">Knative Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="knative-tutorial-adv" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Knative Eventing</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="deploy-apache-kafka.html">Deploy Apache Kafka</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="deploy-apache-kafka.html#create-kafka-topic">Create Topic</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="deploy-apache-kafka.html#kafka-producer">Run Producer</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="deploy-apache-kafka.html#kafka-consumer">Run Consumer</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="eventing-with-kafka.html">Knative Eventing with Apache Kafka</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#kn-eventing-kafka-source">Deploy KafkaSource</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#kn-eventing-adv-default-knative-channel">Kafka Knative Channel</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#kn-eventing-kafka-source-to-sink">Kafka Source to Sink</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#kn-eventing-kafka-auto-scaling">Auto Scaling with Kafka</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#kn-kafka-src-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">EIP with Apache Camel-K</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="camel-k-cbr.html">Content Based Routing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="camel-k-cbr.html#cbr-app-overview">Application Overview</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="camel-k-cbr.html#label-namespace-for-default-broker">Label Namespace</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="camel-k-cbr.html#camel-k-cbr-data-producer">Deploy Data Producer</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="camel-k-cbr.html#camel-k-cbr-data-processor">Deploy Data Processor</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="camel-k-cbr.html#camel-k-cbr-event-subscriber">Deploy Event Subscriber</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="camel-k-cbr.html#camel-k-cbr-event-filter">Apply Knative Filter</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="camel-k-cbr.html#verify-e2e">Verify End to End</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="camel-k-cbr.html#kamel-cbr-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../knative-tutorial/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Knative Tutorial Advanced</a></li>
    <li>Knative Eventing</li>
    <li><a href="eventing-with-kafka.html">Knative Eventing with Apache Kafka</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-developer-demos/knative-tutorial-module-advanced/edit/release/v0.14.x/modules/ROOT/pages/eventing-with-kafka.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Knative Tutorial</h1>
<div class="sect1">
<h2 id="kn-eventing-with-kafka"><a class="anchor" href="#kn-eventing-with-kafka"></a>Apache Kafka Events with Knative Eventing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At the end of this chapter you will be able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using KafkaSource with Knative Eventing</p>
</li>
<li>
<p>Source Kafka Events to Sink</p>
</li>
<li>
<p>Autoscaling Knative Services with Apache Kafka Events</p>
</li>
</ul>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd $TUTORIAL_HOME/eventing</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="kn-eventing-kafka-source"><a class="anchor" href="#kn-eventing-kafka-source"></a>Deploy Knative Eventing KafkaSource</h3>
<div class="paragraph">
<p>Knative Eventing <code>KafkaSource</code> need to be used to have the Kafka messages to flow through the Knative Eventing Channels. You can deploy Knative KafkaSource by running the command:</p>
</div>
<div id="kn-eventing-adv-deploy-kafkasource" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply \
-f <a href="https://github.com/knative/eventing-contrib/\" class="bare">https://github.com/knative/eventing-contrib/\</a>
releases/download/v0.14.1/kafka-source.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The previous step deploys Knative KafkaSource in the <code>knative-sources</code> namespace as well as a CRD, ServiceAccount, ClusterRole, etc.  Verify that knative-source namespace includes the <code>kafka-controller-manager-0</code> pod:</p>
</div>
<div id="watch-kafkasource-controller-pod" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch "kubectl get pods -n knative-sources"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command above should show the following output:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                         READY   STATUS    AGE
kafka-controller-manager-0   1/1     Running   1m17s</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should also deploy the Knative Kafka Channel that can be used to connect the Knative Eventing Channel with a Apache Kafka cluster backend, to deploy a Knative Kafka Channel run:</p>
</div>
<div id="kn-eventing-deploy-kafka-channel" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -L "https://github.com/knative/eventing-contrib/\
releases/download/v0.14.1/kafka-channel.yaml" \
 | sed 's/REPLACE_WITH_CLUSTER_URL/my-cluster-kafka-bootstrap.kafka:9092/' \
 | kubectl apply --filename -</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>"my-cluster-kafka-bootstrap.kafka:9092" comes from <code>kubectl get services -n kafka</code></p>
</li>
<li>
<p>On <strong>OpenShift</strong>, Knative Eventing Kafka operator that was done in earlier, will install Knative KafkaChannel as well.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Look for 3 new pods in namespace <code>knative-eventing</code> with the prefix "kafka":</p>
</div>
<div id="kn-eventing-list-kafka-source-pods" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch "kubectl get pods -n knative-eventing"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command will shown an output like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                    READY   STATUS    RESTARTS   AGE
broker-controller-56b4d58667-mgf4w      1/1     Running   0          3h54m
broker-filter-5bdbc8d8dd-jqrfc          1/1     Running   0          3h54m
broker-ingress-d896b6b46-nvg92          1/1     Running   0          3h54m
eventing-controller-5fc5645584-n42xs    1/1     Running   0          3h54m
eventing-webhook-7674b867dc-qn44m       1/1     Running   0          3h54m
imc-controller-6b548d6468-zcspc         1/1     Running   0          3h54m
imc-dispatcher-655cdf6ff6-x5sxx         1/1     Running   0          3h54m
<strong>kafka-ch-controller-5cf4bdc98-tl8xv     1/1     Running   0          76s</strong>
<strong>kafka-webhook-5f8895ccdf-z6qnw          1/1     Running   0          76s</strong>
mt-broker-controller-6d66c4c6f6-vbpk4   1/1     Running   0          3h54m</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you should also find some new api-resources as shown:</p>
</div>
<div id="kn-eventing-list-api-res-sources" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl api-resources --api-group='sources.knative.dev'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command should show the following APIs in <code>sources.eventing.knative.dev</code> :</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME               SHORTNAMES   APIGROUP              NAMESPACED   KIND
apiserversources                sources.knative.dev   true         ApiServerSource
containersources                sources.knative.dev   true         ContainerSource
<strong>kafkasources                    sources.knative.dev   true         KafkaSource</strong>
pingsources                     sources.knative.dev   true         PingSource
sinkbindings                    sources.knative.dev   true         SinkBinding</code></pre>
</div>
</div>
<div id="kn-eventing-list-api-res-messaging" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl api-resources --api-group='messaging.knative.dev'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command should show the following APIs in <code>messaging.knative.dev</code> :</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME               SHORTNAMES   APIGROUP                NAMESPACED   KIND
channels           ch           messaging.knative.dev   true         Channel
inmemorychannels   imc          messaging.knative.dev   true         InMemoryChannel
<strong>kafkachannels      kc           messaging.knative.dev   true         KafkaChannel</strong>
subscriptions      sub          messaging.knative.dev   true         Subscription</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kn-eventing-adv-default-knative-channel"><a class="anchor" href="#kn-eventing-adv-default-knative-channel"></a>Using Kafka Channel as Default Knative Channel</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://developers.redhat.com/blog/2016/08/10/persistence-vs-durability-in-messaging/">Persistence and Durability</a> are two very important features of any messaging based architectures. The Knative Channel has built-in support for durability. Durability of messages becomes ineffective, if the Knative Eventing Channel does not support persistence. As without persistence it will not be able to deliver the messages to subscribers which might be  offline at the time of message delivery.</p>
</div>
<div class="paragraph">
<p>By default all Knative Channels created by the Knative Eventing API use InMemoryChannel(imc), which does not have capability to persist messages. To enable persistence we need to use one of the supported <a href="https://knative.dev/docs/eventing/channels/channels-crds/">channels</a> such as GCP PubSub, Kafka or Natss as the default Knative Channel backend.</p>
</div>
<div class="paragraph">
<p>We installed <a href="deploy-apache-kafka.html" class="page">Apache Kafka</a>, earlier in this tutorial, let us now configure it to be the default Knative Channel backend:</p>
</div>
<div class="listingblock">
<div class="title">Knative Default Channel ConfigMap</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: ConfigMap
metadata:
  name: default-ch-webhook
  namespace: knative-eventing
data:
  default-ch-config: |
    clusterDefault: <i class="conum" data-value="1"></i><b>(1)</b>
      apiVersion: messaging.knative.dev/v1alpha1
      kind: InMemoryChannel
    namespaceDefaults: <i class="conum" data-value="2"></i><b>(2)</b>
      knativetutorial:
        apiVersion: messaging.knative.dev/v1alpha1
        kind: KafkaChannel
        spec:
          numPartitions: 1
          replicationFactor: 1</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For the cluster we will still use the default InMemoryChannel</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>For the namespace <strong>knativetutorial</strong>, all Knative Eventing Channels will use KafkaChannel as default</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the following command apply the Knative Eventing Channel configuration:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f default-kafka-channel.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since you have now made all Knative Eventing Channels of <strong>knativetutorial</strong> to be KafkaChannel, creating a Knative Eventing Channel in namespace <strong>knativetutorial</strong> will result in a corresponding Kafka Topic created. Let us now verify it by creating a sample Channel as show in listing,</p>
</div>
<div class="listingblock">
<div class="title">Create a example Channel</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: messaging.knative.dev/v1beta1
kind: Channel
metadata:
  name: my-events-ch
  namespace: knativetutorial
spec: {}
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Channel <code>my-events-ch</code> creation will result in the following resources in the <code>knativetutorial</code></p>
</div>
<div class="paragraph">
<p>A <code>channel.messaging.knative.dev</code> called <code>my-events-ch</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get -n knativetutorial channels</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME           READY   URL
my-events-ch   True    <a href="http://my-events-ch-kn-channel.knativetutorial.svc.cluster.local" class="bare">http://my-events-ch-kn-channel.knativetutorial.svc.cluster.local</a></code></pre>
</div>
</div>
<div class="paragraph">
<p>And a corresponding <code>kafkachannel.messaging.knative.dev</code> with the same name <code>my-events-ch</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get -n knativetutorial kafkachannels</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME           READY  URL
my-events-ch   True   <a href="http://my-events-ch-kn-channel.knativetutorial.svc.cluster.local" class="bare">http://my-events-ch-kn-channel.knativetutorial.svc.cluster.local</a></code></pre>
</div>
</div>
<div class="paragraph">
<p>When you now list the topics that are available in Kafka using the script <code>$TUTORIAL_HOME/bin/kafka-list-topics.sh</code>, you should see a topic corresponding to your Channel <code>my-events-ch</code>:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$TUTORIAL_HOME/bin/kafka-list-topics.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command should return an output like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">knative-messaging-kafka.knativetutorial.my-events-ch</code></pre>
</div>
</div>
<div class="paragraph">
<p>For each Knative Eventing Channel that you will create, there will be a Kafka Topic created, the topic&#8217;s name will follow a convention like <code>knative-messaging-kafka.&lt;your-channel-namespace&gt;.&lt;your-channel-name&gt;</code>.</p>
</div>
<div class="paragraph">
<p>When listing the resources of <code>knative-eventing</code> , you should see an extra deployment called <code>kafka-ch-dispatcher</code> with its corrsponding pod started:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get -n knative-eventing pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                    READY   STATUS    RESTARTS   AGE
broker-controller-56b4d58667-tz77k      1/1     Running   0          19h
broker-filter-5bdbc8d8dd-2b657          1/1     Running   0          19h
broker-ingress-d896b6b46-xss59          1/1     Running   0          19h
eventing-controller-5fc5645584-fqz72    1/1     Running   0          19h
eventing-webhook-7674b867dc-x2lg2       1/1     Running   0          19h
imc-controller-6b548d6468-v4pr8         1/1     Running   0          19h
imc-dispatcher-655cdf6ff6-xftlk         1/1     Running   0          19h
kafka-ch-controller-5cf4bdc98-l8lqg     1/1     Running   0          32m
<strong>kafka-ch-dispatcher-7fb7896db4-6r7m6    1/1     Running   0          24m</strong>
kafka-webhook-5f8895ccdf-hf28p          1/1     Running   0          32m
mt-broker-controller-6d66c4c6f6-56s9s   1/1     Running   0          19h</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can delete the example <code>my-events-ch</code> channel using the command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knativetutorial delete  channels.messaging.knative.dev my-events-ch</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="kn-eventing-kafka-source-to-sink"><a class="anchor" href="#kn-eventing-kafka-source-to-sink"></a>Connecting Kafka Source to Sink</h3>
<div class="paragraph">
<p>Now, all of your infrastructure is configured, you can deploy the Knative Serving Service(sink) by running the command:</p>
</div>
<div id="kn-kafka-src-eventing-hello" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n knativetutorial -f eventing-hello-sink.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the Knative Service that was created by the command above:</p>
</div>
<div id="kn-kafka-src-eventing-hello-ksvc" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get ksvc</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the Knative Service that was created by the command above. The command should show an output like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME            URL                                      READY
eventinghello   http://eventinghello.kafka.example.com   True</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure to follow the logs using <code>stern</code>:</p>
</div>
<div id="kn-kafka-src-sink-stern" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">stern eventinghello -c user-container</code></pre>
</div>
</div>
<div class="paragraph">
<p>The initial deployment of <code>eventinghello</code> will cause it to scale up to 1 pod.  It will be around until it hits its scale-down time limit.  Allow it to scale down to zero pods before continuing.</p>
</div>
<div class="paragraph">
<p>Create <code>KafkaTopic</code> called <code>my-topic</code> as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: kafka.strimzi.io/v1beta1
kind: KafkaTopic
metadata:
  name: my-topic
  labels:
    strimzi.io/cluster: my-cluster
spec:
  partitions: 10
  replicas: 1</code></pre>
</div>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n kafka \
  -f kafka-topic-my-topic.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the created topics by:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get -n kafka kafkatopics</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command should show an output like:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                                          PARTITIONS   REPLICATION FACTOR
consumer-offsets---84e7a678d08f4bd226872e5cdd4eb527fadc1c6a   50           1
<strong>my-topic                                                      <em>10</em>           1</strong></code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a <code>KafkaSource</code> for <code>my-topic</code> by connecting your Kafka topic <code>my-topic</code> to eventinghello:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: sources.knative.dev/v1alpha1
kind: KafkaSource
metadata:
  name: mykafka-source
spec:
  consumerGroup: knative-group
  bootstrapServers: my-cluster-kafka-bootstrap.kafka:9092 <i class="conum" data-value="1"></i><b>(1)</b>
  topics: my-topic <i class="conum" data-value="2"></i><b>(2)</b>
  sink: <i class="conum" data-value="3"></i><b>(3)</b>
    ref:
      apiVersion: serving.knative.dev/v1
      kind: Service
      name: eventinghello</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>"my-cluster-kafka-bootstrap:9092" can be found via <code>kubectl get -n kafka services</code> or <code>oc get  -n kafka services</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>my-topic</code> was created earlier <a href="deploy-apache-kafka.html#create-kafka-topic" class="page">section</a> when deploying Apache Kafka</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This is another example of a direct <a href="#knative-tutorial-eventing:ROOT:eventing-src-to-sink.adoc.adoc#eventing-sink-service" class="page unresolved">Source to Sink</a></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The deployment of <code>KafkaSource</code> will result in a new pod prefixed with "mykafka-source".</p>
</div>
<div id="kn-kafka-source-deploy" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knativetutorial apply -f mykafka-source.yaml</code></pre>
</div>
</div>
<div id="kn-kafka-source-status-watch" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch kubectl get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the KafkaSource is ready it will show the following output:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                          READY  STATUS   RESTARTS  AGE
mykafka-source-vxs2k-56548756cc-j7m7v         1/1    Running  0         11s</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Since we had test messages of "one", "two" and "three" from earlier you might see the eventinghello service awaken to process those messages.</p>
</div>
<div class="paragraph">
<p>Wait for eventinghello to scale down to zero pods before moving on then push more Kafka messages into my-topic.</p>
</div>
</td>
</tr>
</table>
</div>
<div id="kn-kakfa-source-producer-events" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$TUTORIAL_HOME/bin/kafka-producer.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then enter the following messages:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Hello World

Hola Mundo

Bonjour Le Monde

Namaste Duniya</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Knative Eventing events through the Kafka Source must be JSON formatted</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>While making sure to monitor the logs of the <code>eventinghello</code> pod:</p>
</div>
<div id="stern-kafka-src-events" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">stern eventinghello -c user-container</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ce-id=partition:1/offset:1
ce-source=/apis/v1/namespaces/kafka/kafkasources/mykafka-source#my-topic
ce-specversion=1.0
ce-time=2020-01-01T01:16:12.886Z
ce-type=dev.knative.kafka.event
content-type=null
content-length=17
POST:Namaste Duniya</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If the <code>eventinghello</code> sink was scaled down by Knative due to inactivity, you will see the service comeup to serve the request once the message is sent</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kn-eventing-kafka-auto-scaling"><a class="anchor" href="#kn-eventing-kafka-auto-scaling"></a>Auto Scaling with Apache Kafka</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Allow all the <code>eventinghello</code> sink pods to scale down to zero.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Open a new terminal and watch the pods of <code>knativetutorial</code> namespace:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch kubectl get pods -n knativetutorial</code></pre>
</div>
</div>
<div class="paragraph">
<p>We will use a utility pod called <code>kafka-spammer</code> to send a bunch of messages to KafkaTopic <code>my-topic</code>, which in turn will trigger the Knative sink service <code>eventinghello</code> to scale up to handle the KakaTopic message events.</p>
</div>
<div class="paragraph">
<p>Deploy <code>kafka-spammer</code> application using the command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n kafka run kafka-spammer \
--image=quay.io/rhdevelopers/kafkaspammer:1.0.2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for the <code>kafka-spammer</code> pod to be up and running, you can watch <code>kafka</code> namespace for the pod:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch kubectl -n kafka get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the <code>kafka-spammer</code> is up and running, open a new terminal and exec into the pod by running:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">KAFKA_SPAMMER_POD=$(kubectl -n kafka get pod -l "run=kafka-spammer" \
-o jsonpath='{.items[0].metadata.name}')
kubectl -n kafka exec -it $KAFKA_SPAMMER_POD -- /bin/sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you are in the shell of the <code>kafka-spammer</code> pod run the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl localhost:8080/3</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command should now send three concurrent messages to KafkaTopic <code>my-topic</code>. As the`eventinghello` sink pods were scaled down to zero, you should see three or more <code>eventinghello</code> sink pods being scaled to serve the request.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                                              READY   STATUS    RESTARTS   AGE
camel-k-operator-65db5d46bb-llc6g                                 1/1     Running   0          20h
<strong>eventinghello-v1-deployment-57c686cc96-6k9r2                      2/2     Running   0          15s</strong>
<strong>eventinghello-v1-deployment-57c686cc96-jcv8b                      2/2     Running   0          13s</strong>
<strong>eventinghello-v1-deployment-57c686cc96-lh8xr                      2/2     Running   0          15s</strong>
<strong>eventinghello-v1-deployment-57c686cc96-n2slh                      2/2     Running   0          16s</strong>
kafkasource-mykafka-source-a29a50ca-4d76-4e65-8b96-1507372bfphb   1/1     Running   0          119s</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="kn-kafka-src-cleanup"><a class="anchor" href="#kn-kafka-src-cleanup"></a>Cleanup</h3>
<div id="kn-eventing-kafka-src-cleanup" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete -n kafka pod kafka-spammer
kubectl delete -n knativetutorial  -f mykafka-source.yaml
kubectl delete -n knativetutorial  -f eventing-hello-sink.yaml
kubectl delete -n kafka -f kafka-topic-my-topic.yaml</code></pre>
</div>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
