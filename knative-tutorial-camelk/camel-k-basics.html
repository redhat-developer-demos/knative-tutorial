<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Knative Tutorial :: Knative Tutorial</title>
    <link rel="canonical" href="https://redhat-developer-demos.github.io/knative-tutorial/knative-tutorial-camelk/camel-k-basics.html">
    <meta name="generator" content="Antora 2.3.3">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://redhat-developer-demos.github.io/knative-tutorial">Knative Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="knative-tutorial-camelk" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="setup.html">Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html#install-camel-k">Install Camel-K </a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="camel-k-basics.html">Camel-K with Knative Serving</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#deploy-camel-k-integration">Deploy Camel-K integration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#deploy-camel-k-kn-integration">Deploy Camel-K Knative Integration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#camelk-gs-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="camel-k-eventing.html">Camel-K with Knative Eventing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="camel-k-eventing.html#deploy-camel-k-source">Deploy Knative CamelSource</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="camel-k-eventing.html#logging-ce-messages">View CloudEvents Messages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="camel-k-eventing.html#camel-k-es-sink">CamelSource to Sink</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="camel-k-eventing.html#camelk-eventing-cleanup">Cleanup</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../knative-tutorial/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Knative with Apache Camel-K</a></li>
    <li><a href="camel-k-basics.html">Camel-K with Knative Serving</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/redhat-developer-demos/knative-tutorial-module-camelk/edit/release/v0.14.x/modules/ROOT/pages/camel-k-basics.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Knative Tutorial</h1>
<div class="sect1">
<h2 id="camel-k-basics"><a class="anchor" href="#camel-k-basics"></a>Camel-K Basics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At the end of this chapter you will be able to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Understand Camel-K deployment</p>
</li>
<li>
<p>How to create Camel-K integration</p>
</li>
<li>
<p>How to run using development mode</p>
</li>
<li>
<p>How to add dependencies to Camel-K</p>
</li>
<li>
<p>How to run your Camel-K integration in serverless mode</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Navigate to the tutorial chapter&#8217;s folder advanced/camel-k:</p>
</div>
<div id="camelk-repo-nav-folder" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd $TUTORIAL_HOME/advanced/camel-k</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="deploy-camel-k-integration"><a class="anchor" href="#deploy-camel-k-integration"></a>Deploy Camel-K integration</h3>
<div class="paragraph">
<p>Camel-K helps you in writing the Apache Camel integrations using Java, JS, XML and as YAML.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For all the integration exercises, we will be using YAML DSL.</p>
</div>
<div class="paragraph">
<p>Apache Camel YAML DSL is still under active development but using this DSL will give you a consistent resource definition across Kubernetes, Knative and Camel-K</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let us analyze our first Camel-K integration before running it. A Camel-K integration resource is an array of one flow or multiple route definitions. The following listing shows you simple timer integration with just one route:</p>
</div>
<div class="listingblock">
<div class="title">Camel K integration - greeter</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- from:
    uri: "timer:tick" <i class="conum" data-value="1"></i><b>(1)</b>
    parameters: <i class="conum" data-value="2"></i><b>(2)</b>
      # time in milliseconds (10 seconds)
      period: 10000
    steps: <i class="conum" data-value="3"></i><b>(3)</b>
      - set-body: <i class="conum" data-value="4"></i><b>(4)</b>
          constant: "Welcome to Apache Camel K"
      - set-header: <i class="conum" data-value="5"></i><b>(5)</b>
          name: ContentType
          simple: text/plain
      - transform: <i class="conum" data-value="6"></i><b>(6)</b>
          simple: "${body.toUpperCase()}"
      - to: <i class="conum" data-value="7"></i><b>(7)</b>
          uri: "log:info?multiline=true&amp;showAll=true"</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The Apache Camel producer URI, in this case it is the <a href="https://camel.apache.org/components/latest/timer-component.html">timer</a> component.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>parameters</code> allows to specify the configurable properties of the component. In this case the timer component needs to tick every <code>10</code> seconds.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>steps</code> defines the flow of Camel exchange(IN). Each Camel K integration should have at least one step defined.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Sets the body of the Camel exchange(OUT), a constant value of "Welcome to Apache Camel K"</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>It is possible to set headers as part of the step, this sets the <code>ContentType</code> header with its value <code>text/plain</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>It is possible to apply transformations as part of a step. This applies a simple transformation of converting the exchange OUT body to uppercase.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>In the end you send the processed exchange(OUT) to its desired destination, here we simply log it out.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is possible  have any number of steps as needed for an integration based on your use case. In the later sections of this chapter you will deploy multi-step based integration examples.</p>
</div>
<div class="paragraph">
<p><code>kamel</code> CLI tool is used to deploy the integrations. Run the following command to</p>
</div>
<div id="deploy-integration-dev-mode" class="listingblock console-input">
<div class="title">Deploy the greeter integration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kamel run --dev get-started/timed-greeter.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>A typical Camel K integration deployment will take approximately 2-5 minutes, as it involves multiple steps such as:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Building an integration kit(camel-k-kit) which builds the container image with all the required Camel modules downloaded and added to classpath within the container image.</p>
</li>
<li>
<p>If using Knative then deploy as a Knative Service</p>
</li>
<li>
<p>Run the container image as a Kubernetes pod and start the Camel context</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once the integration is built, you sill see the terminal populated with logs from the integration like:</p>
</div>
<div class="listingblock console-output">
<div class="title">timed-greeter logs</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># kamel run --dev get-started/timed-greeter.yaml
...
[1] 2020-01-13 03:25:28.548 INFO  [Camel (camel-k) thread #1 - timer://tick] info - Exchange[
[1]   Id: ID-timed-greeter-57b4d49974-vg859-1578885868551-0-13
[1]   ExchangePattern: InOnly
[1]   Properties: {CamelCreatedTimestamp=Mon Jan 13 03:25:28 UTC 2020, CamelExternalRedelivered=false, CamelMessageHistory=[DefaultMessageHistory[routeId=route1, node=setBody1], DefaultMessageHistory[routeId=route1, node=setHeader1], DefaultMessageHistory[routeId=route1, node=transform1], DefaultMessageHistory[routeId=route1, node=to1]], CamelTimerCounter=7, CamelTimerFiredTime=Mon Jan 13 03:25:28 UTC 2020, CamelTimerName=tick, CamelTimerPeriod=10000, CamelToEndpoint=log://info?multiline=true&amp;showAll=true}
[1]   Headers: {ContentType=text/plain, firedTime=Mon Jan 13 03:25:28 UTC 2020}
[1]   BodyType: String
[1]   Body: WELCOME TO APACHE CAMEL K
[1] ]</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are not using maven repository manager or it takes long time to download maven artifacts, your earlier command <code>kamel run --dev ..</code> will report a failure. In those cases, run the command <code>kamel get</code> to see the status of the integration. Once you see the <code>timed-greeter</code> pod running, then use <code>kamel log timed-greeter</code> to see the logs as shown in the earlier listing.</p>
</div>
<div class="paragraph">
<p>You can use Ctrl+C to stop the running Camel K integration and it automatically terminate its pods. If you had encountered the dev mode failure as described earlier, try to delete the integration using the command <code>kamel delete timed-greeter</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>dev</code> mode allows live reload of code. Update the <code>timed-greeter.yaml</code> body text to be "Hi Camel K rocks!" and observe the automatic reloading of the context and the logs printing the new message.</p>
</div>
</div>
<div class="sect2">
<h3 id="deploy-camel-k-kn-integration"><a class="anchor" href="#deploy-camel-k-kn-integration"></a>Deploy Camel-K Knative Integration</h3>
<div class="paragraph">
<p>Any Camel-K integration can be converted into a serverless service using Knative. For an integration to be deployed as a Knative Service you need to use the Camel-K's <code>knative</code> component.</p>
</div>
<div class="paragraph">
<p>The Camel-K Knative component provides two consumers: <code>knative:endpoint</code> and <code>knative:channel</code>. The former is used to deploy the integration as Knative Service, while the later is used to handle events from a Knative Event channel.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Knative endpoints can be either a Camel producer or consumer depending on the context and need.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We wil now deploy a <code>knative:endpoint</code> consumer as part of your integration, that will add the serverless capabilities to your Camel-K integration using Knative.</p>
</div>
<div class="paragraph">
<p>The following listing shows a simple <code>echoer</code> Knative Camel-K integration, that will simply respond to your Knative Service call with same body that you sent into it in uppercase form.  If there is no body received the service will respond with "no body received":</p>
</div>
<div class="listingblock">
<div class="title">Echoer Integration</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">- from:
    uri: "knative:endpoint/echoer" <i class="conum" data-value="1"></i><b>(1)</b>
    steps:
      - log:
          message: "Got Message: ${body}"
      - convert-body-to: "java.lang.String" <i class="conum" data-value="2"></i><b>(2)</b>
      - choice:
          when:
            - simple: "${body} != null &amp;&amp; ${body.length} &gt; 0"
              steps:
                - set-body:
                    simple: "${body.toUpperCase()}"
                - set-header:
                    name: ContentType
                    simple: text/plain
                - log:
                    message: "${body}"
          otherwise:
            steps:
              - set-body:
                  constant: "no body received"
              - set-header:
                  name: ContentType
                  simple: text/plain
              - log:
                  message: "Otherwise::${body}"</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The consumer needs to be a Knative endpoint URI of form <code>knative:endpoint/&lt;your endpoint name&gt;</code>, the name of the Knative service will be the last path segment of the URI, in this case your Knative service will be called <code>echoer</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You will be converting the incoming data (request body) to <code>java.lang.String</code> as that will help you in converting to upper case.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can run this integration as shown in the following listing. If you notice that you are now deploying the integration in production mode i.e without <code>--dev</code> option.</p>
</div>
<div id="camel-k-kn-run" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kamel run --wait get-started/echoer.yaml</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You can use <code>stern camel-k</code> to monitor the progress of the builder pod as well as <code>watch kubectl kamel get</code> and monitor the <strong>PHASE</strong> column.  In addition, <code>watch kubectl get ksvc</code> looking at the <strong>READY</strong> column to become True.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Since its the production mode and it takes some time for the integration to come up, you need to watch the integration's logs using the command <code>kamel log &lt;integration name&gt;</code> i.e. <code>kamel log echoer</code> and you can get the name of the integration using the command <code>kamel get</code>.</p>
</div>
<div class="paragraph">
<p>In the integration that you had deployed, you had applied the <a href="https://camel.apache.org/components/latest/eips/choice-eip.html" class="ext-link" target="_blank" rel="noopener">Choice EIP</a> when processing the exchange body. When the body has content then it simply converts the body to upper case otherwise it returns a canned response of "no body received". In either case, the content type header is set to <code>text/plain</code>.</p>
</div>
<div class="paragraph">
<p>Camel-K defines an <code>integration</code> via Custom Resource Definition (CRD) and you can view those CRDs and the actual <code>integrations</code> via the following commands:</p>
</div>
<div id="camel-k-crds" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl api-resources --api-group=camel.apache.org</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command above shows the following output:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                   SHORTNAMES   APIGROUP           NAMESPACED   KIND
builds                              camel.apache.org   true         Build
camelcatalogs          cc           camel.apache.org   true         CamelCatalog
integrationkits        ik           camel.apache.org   true         IntegrationKit
integrationplatforms   ip           camel.apache.org   true         IntegrationPlatform
integrations           it           camel.apache.org   true         Integration</code></pre>
</div>
</div>
<div id="camel-k-list-int" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">watch kubectl -n knativetutorial get integrations</code></pre>
</div>
</div>
<div class="paragraph">
<p>A successful integration deployment should show the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME              PHASE     KIT                        REPLICAS
echoer            Running   kit-bodug9d83u4bmr3uh8jg   1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the integration is started, you can check the Knative service using the command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl -n knativetutorial get ksvc echoer</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the service is in a ready state use the call script <code>$TUTORIAL/bin/call.sh</code> with parameter <code>echoer</code> and a request body of "Hello World":</p>
</div>
<div id="call-echoer-with-param" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$TUTORIAL_HOME/bin/call.sh echoer 'Hello World'</code></pre>
</div>
</div>
<div id="call-echoer-without-param" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$TUTORIAL_HOME/bin/call.sh echoer ''</code></pre>
</div>
</div>
<div class="paragraph">
<p>The invocation of a Knative Camel-K Integration is a bit different than previous Knative test calls.  The Knative Camel-K integration service is expecting a POST where the input data is part of the request body.  Therefore, you need to a few different elements to construct the invocation, the following snippet from <code>$TUTORIAL_HOME/bin/call.sh</code> shows how a Knative service call is constructed:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"><strong>NODE_PORT=$(kubectl get svc kourier --namespace kourier-system \
  --output 'jsonpath={.spec.ports[?(@.port==80)].nodePort}')</strong> <i class="conum" data-value="1"></i><b>(1)</b>
<strong>IP_ADDRESS="$(minikube ip):$NODE_PORT"</strong> <i class="conum" data-value="2"></i><b>(2)</b>
<strong>HOST_HEADER="Host:echoer.knativetutorial.example.com"</strong> <i class="conum" data-value="3"></i><b>(3)</b>
<strong>curl -X POST -H $HOST_HEADER -d "Hello World" $IP_ADDRESS</strong> <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>All Knative traffic should flow through the Istio Ingress gateway and NodePort is the easiest solution on minikube</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Minikube, which is running as a VM on your local machine, provides a local IP address (e.g. 192.168.99.100)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The host header can be determined by running <code>kubectl get ksvc echoer</code>, just make sure to <strong>remove</strong> the "http://" prefix</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>curl with a POST</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Explore the <code>kamel</code> tool via its help option of <code>kamel --help</code> to see the list of available commands and their respective options.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="cleanup"><a class="anchor" href="#cleanup"></a>Cleanup</h3>
<div id="camelk-gs-cleanup" class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$TUTORIAL_HOME/bin/clean-completed.sh
kamel delete echoer</code></pre>
</div>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
